/* =============================================
   MindMap Editor
   ============================================= */

.mindmap-editor-page {
  display: flex;
  flex-direction: column;
  height: calc(100vh - 60px);
  overflow: hidden;
  outline: none;
}

.mindmap-loading {
  padding: 3rem;
  text-align: center;
  color: var(--color-text-muted);
}

/* ── Toolbar ───────────────────────────────── */
.mindmap-toolbar {
  display: flex;
  align-items: center;
  gap: 0.625rem;
  padding: 0.5rem 1.25rem;
  background: var(--color-surface);
  border-bottom: 1px solid var(--color-border);
  flex-shrink: 0;
  flex-wrap: wrap;
}
.btn-back {
  display: flex; align-items: center; gap: 0.3rem;
  padding: 0.375rem 0.75rem;
  background: transparent;
  border: 1px solid var(--color-border);
  border-radius: 7px;
  color: var(--color-text-secondary);
  cursor: pointer; font-size: 0.8125rem; font-weight: 500;
  white-space: nowrap; transition: background 0.15s; width: auto;
}
.btn-back:hover { background: var(--color-input-bg); color: var(--color-text-main); }

.mindmap-title {
  flex: 1; font-size: 0.9375rem; font-weight: 600;
  color: var(--color-text-main); margin: 0;
  white-space: nowrap; overflow: hidden; text-overflow: ellipsis; min-width: 0;
}

.mm-dir-group {
  display: flex; border: 1px solid var(--color-border);
  border-radius: 7px; overflow: hidden; flex-shrink: 0;
}
.mm-dir-btn {
  padding: 0.3125rem 0.65rem;
  background: var(--color-surface); border: none;
  border-right: 1px solid var(--color-border);
  color: var(--color-text-secondary);
  font-size: 0.75rem; font-weight: 500; cursor: pointer;
  transition: background 0.15s; width: auto;
}
.mm-dir-btn:last-child { border-right: none; }
.mm-dir-btn:hover { background: var(--color-input-bg); }
.mm-dir-btn.active {
  background: var(--color-primary-light);
  color: var(--color-primary); font-weight: 600;
}

/* ── Mode toggle ───────────────────────────── */
.mm-mode-btn {
  display: flex; align-items: center; gap: 0.3rem;
  padding: 0.3rem 0.7rem;
  background: var(--color-surface);
  border: 1.5px solid var(--color-border);
  border-radius: 7px;
  color: var(--color-text-secondary);
  font-size: 0.78rem; font-weight: 500; cursor: pointer;
  white-space: nowrap; transition: all 0.15s; flex-shrink: 0;
}
.mm-mode-btn:hover { background: var(--color-input-bg); color: var(--color-text-main); }
.mm-mode-btn.active {
  background: var(--mm-l2-bg, #EEEEFF);
  border-color: var(--mm-accent, #7B7EFF);
  color: var(--mm-accent, #7B7EFF);
}

.mindmap-toolbar-actions { display: flex; gap: 0.375rem; flex-shrink: 0; }
.btn-tool {
  display: flex; align-items: center; gap: 0.3rem;
  padding: 0.375rem 0.75rem;
  background: var(--color-primary-light); color: var(--color-primary);
  border: 1px solid rgba(108, 92, 231, 0.2); border-radius: 7px;
  cursor: pointer; font-size: 0.8125rem; font-weight: 500;
  white-space: nowrap; transition: background 0.15s; width: auto;
}
.btn-tool:hover { background: rgba(108, 92, 231, 0.18); }
.btn-tool--icon { padding: 0.375rem 0.5rem; }

/* ── Hint bar ──────────────────────────────── */
.mindmap-hint {
  padding: 0.3rem 1.25rem;
  font-size: 0.72rem; color: var(--color-text-muted);
  background: var(--color-surface);
  border-top: 1px solid var(--color-border);
  margin: 0; flex-shrink: 0; display: flex; align-items: center; gap: 0.375rem; flex-wrap: wrap;
}
.mm-hint-sep { color: var(--color-border); }
.mm-hint-tag {
  display: inline-block; padding: 0.0625rem 0.375rem;
  background: rgba(108,92,231,0.1); color: var(--color-primary);
  border-radius: 4px; font-size: 0.7rem; font-weight: 600;
}

/* ── Canvas ────────────────────────────────── */
.mindmap-main {
  flex: 1;
  min-height: 0;
  display: flex;
  flex-direction: column;
}

.mindmap-flow-container { flex: 1; min-height: 0; }
.mindmap-flow-container .react-flow { background: #ffffff; }

/* Text 模式下隐藏画布容器，但保持 React Flow 挂载，避免卸载时 removeChild 异常 */
.mindmap-flow-container--hidden {
  display: none;
}

/* Make-way animation: non-dragged nodes slide smoothly */
.react-flow__node { transition: transform 0.14s ease; }
.react-flow__node.dragging { transition: none !important; }
/* 切换布局后逐级展开时，节点位置变化带过渡动效 */
.mindmap-flow-container.mm-expanding .react-flow__node {
  transition: transform 0.28s cubic-bezier(0.25, 0.46, 0.45, 0.94);
}
.mindmap-flow-container.mm-expanding .react-flow__node.dragging {
  transition: none !important;
}

/* React Flow overrides */
.react-flow__controls {
  background: var(--color-surface); border: 1px solid var(--color-border);
  border-radius: 8px; box-shadow: 0 1px 4px rgba(0,0,0,0.08); overflow: hidden;
}
.react-flow__controls-button {
  background: var(--color-surface);
  border-bottom: 1px solid var(--color-border);
}
.react-flow__controls-button:hover { background: var(--color-input-bg); }
.react-flow__controls-button svg { fill: var(--color-text-secondary); max-width: 12px; }
.react-flow__controls-button:hover svg { fill: var(--color-primary); }
.react-flow__minimap {
  background: var(--color-surface); border: 1px solid var(--color-border);
  border-radius: 8px; box-shadow: 0 1px 4px rgba(0,0,0,0.08);
}
/* ── Zoom Ruler ─────────────────────────────────────── */
.mm-zoom-ruler {
  position: absolute; right: 16px; top: 50%; transform: translateY(-50%);
  display: flex; flex-direction: column; align-items: center; gap: 6px;
  z-index: 5; user-select: none;
}
.mm-zoom-btn {
  width: 26px; height: 26px; border-radius: 50%;
  border: 1px solid var(--color-border); background: var(--color-surface);
  color: var(--color-text-main); font-size: 15px; line-height: 1;
  cursor: pointer; display: flex; align-items: center; justify-content: center;
  box-shadow: 0 1px 4px rgba(0,0,0,0.08); transition: background 0.15s, color 0.15s;
}
.mm-zoom-btn:hover:not(:disabled) { background: var(--color-input-bg); color: var(--color-primary); }
.mm-zoom-btn:disabled { opacity: 0.35; cursor: default; }

.mm-zoom-track {
  position: relative; width: 24px; height: 160px; cursor: pointer;
}
.mm-zoom-track-line {
  position: absolute; left: 50%; top: 0; bottom: 0; width: 2px;
  transform: translateX(-50%); background: var(--color-border); border-radius: 1px;
}
.mm-zoom-tick {
  position: absolute; left: 0; right: 0;
  display: flex; align-items: center;
  transform: translateY(50%); cursor: pointer;
}
.mm-zoom-tick-label {
  position: absolute; right: calc(100% + 5px);
  font-size: 10px; font-weight: 500; color: var(--color-text-secondary);
  white-space: nowrap; line-height: 1;
  transition: color 0.15s;
}
.mm-zoom-tick.active .mm-zoom-tick-label { color: var(--color-primary); font-weight: 700; }
.mm-zoom-tick-dot {
  position: absolute; left: 50%; width: 7px; height: 7px;
  border-radius: 50%; background: var(--color-border); border: 1.5px solid var(--color-surface);
  transform: translateX(-50%); z-index: 1; transition: background 0.15s;
}
.mm-zoom-tick.active .mm-zoom-tick-dot { background: var(--color-primary); width: 9px; height: 9px; }
.mm-zoom-tick:hover .mm-zoom-tick-dot { background: var(--color-primary); opacity: 0.6; }

.mm-zoom-handle {
  position: absolute; left: 50%; width: 14px; height: 14px;
  border-radius: 50%; background: var(--color-primary); border: 2px solid #fff;
  transform: translate(-50%, 50%); box-shadow: 0 1px 5px rgba(0,0,0,0.22);
  cursor: grab; z-index: 2; transition: box-shadow 0.1s;
}
.mm-zoom-handle:active { cursor: grabbing; box-shadow: 0 2px 8px rgba(0,0,0,0.3); }

.mm-zoom-pct {
  font-size: 10px; font-weight: 600; color: var(--color-text-secondary);
  background: var(--color-surface); border: 1px solid var(--color-border);
  border-radius: 4px; padding: 1px 5px; letter-spacing: 0.02em;
  pointer-events: none;
}

/* ── colour palette for nodes (matches reference screenshot) ── */
:root {
  --mm-accent:      #7B7EFF;   /* main purple-blue  */
  --mm-accent-dark: #5B5EDD;   /* hover / border accent */
  --mm-l2-bg:       #EEEEFF;   /* list node fill */
  --mm-l2-border:   #C8CAFF;   /* list node border */
  --mm-task-bg:     #ffffff;   /* task node fill */
  --mm-task-border: #E0E2ED;   /* task node border */
  --mm-edge:        #C5C9D6;   /* connector line */
}

/* ── Nodes ─────────────────────────────────── */
/* 所有节点用 box-sizing: border-box，保证 width/height 是总尺寸（含 border/padding） */
.mm-node {
  position: relative;
  box-sizing: border-box;
  display: flex; align-items: center;
  padding: 0.25rem 0.75rem;
  background: var(--mm-task-bg);
  border: 1.5px solid var(--mm-task-border);
  border-radius: 5px;
  box-shadow: 0 1px 3px rgba(0,0,0,0.06);
  transition: border-color 0.15s, box-shadow 0.15s;
  font-size: 0.8rem;
  color: #2D2F45;
  cursor: default;
  /* width 固定，height 随内容自适应（多行文字时撑高）*/
  width: 220px; min-height: 36px;
  overflow: visible;
}
.mm-node--selected {
  border-color: var(--mm-accent);
  box-shadow: 0 0 0 2px rgba(123,126,255,0.18);
}

/* Root node — solid purple fill, white text */
.mm-node--root {
  background: var(--mm-accent);
  border: none;
  border-radius: 7px;
  padding: 0.375rem 1.125rem;
  box-shadow: 0 2px 8px rgba(123,126,255,0.28);
  width: 160px; min-height: 36px;
}
.mm-node--root .mm-node__label {
  font-size: 0.9rem; font-weight: 700; color: #ffffff;
}
.mm-node--root .mm-node__input {
  color: #ffffff;
}
.mm-node--root.mm-node--selected {
  box-shadow: 0 0 0 3px rgba(123,126,255,0.38), 0 2px 8px rgba(123,126,255,0.28);
}

/* List node (depth 1) — light purple fill + left accent */
.mm-node--list {
  background: var(--mm-l2-bg);
  border-color: var(--mm-l2-border);
  border-left: 3px solid var(--mm-accent);
  width: 130px; min-height: 36px;
}
.mm-node--list .mm-node__label { font-size: 0.8rem; font-weight: 600; color: #3D3F6E; }
.mm-node--list.mm-node--selected { border-color: var(--mm-accent); }

/* Task node (depth 2+) — white, subtle border */
.mm-node--task {
  background: var(--mm-task-bg);
  border-color: var(--mm-task-border);
  /* 继承 .mm-node 的 width:220px; height:36px */
}
.mm-node--task.mm-node--selected { border-color: var(--mm-accent); }

/* Text mode — no border, smaller spacing */
.mm-node--text-mode {
  border: none !important;
  box-shadow: none !important;
  padding: 0.15rem 0.5rem;
  min-height: 28px;
}
.mm-node--text-mode.mm-node--selected {
  background: rgba(123, 126, 255, 0.08);
  box-shadow: none !important;
}
.mm-node--text-mode .mm-node__label,
.mm-node--text-mode .mm-node__rich {
  line-height: 1.3;
}

/* ── Text Editor ─────────────────────────────────────── */
.mindmap-text-editor-container {
  flex: 1;
  min-height: 0;
  display: flex;
  flex-direction: column;
  background: #ffffff;
  position: relative;
  overflow: hidden;
}

.mindmap-text-editor {
  flex: 1;
  width: 100%;
  padding: 1.5rem;
  border: none;
  outline: none;
  font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Helvetica Neue', 'Arial', 'Noto Sans', sans-serif, 'Apple Color Emoji', 'Segoe UI Emoji', 'Segoe UI Symbol';
  font-size: 14px;
  line-height: 1.8;
  color: #2D2F45;
  background: transparent;
  resize: none;
  white-space: pre;
  overflow-wrap: normal;
  overflow-x: auto;
  tab-size: 2;
  letter-spacing: 0.01em;
  position: relative;
  z-index: 2;
}

.mindmap-text-editor::placeholder {
  color: #b0b4c8;
  font-style: italic;
}

/* 缩进竖线标记层（类似代码编辑器） */
.mindmap-text-editor-container::before {
  content: '';
  position: absolute;
  left: 1.5rem;
  top: 0;
  bottom: 0;
  width: calc(100% - 1.5rem);
  background-image: 
    repeating-linear-gradient(
      to right,
      transparent 0,
      transparent calc(2ch - 1px),
      rgba(220, 220, 230, 0.35) calc(2ch - 1px),
      rgba(220, 220, 230, 0.35) calc(2ch - 0.5px),
      transparent calc(2ch - 0.5px),
      transparent 2ch
    );
  pointer-events: none;
  z-index: 0;
  background-position: 0 0;
  background-size: 2ch 100%;
  background-repeat: repeat-x;
}

/* 装饰层：L 形连线和圆点 */
.mindmap-text-decoration {
  position: absolute;
  left: 0;
  top: 0;
  right: 0;
  bottom: 0;
  pointer-events: none;
  z-index: 1;
  padding: 1.5rem;
  font-size: 14px;
  line-height: 1.8;
}

.mindmap-text-decoration-svg {
  display: block;
  width: 100%;
  height: 100%;
}

.mm-text-line-decoration {
  position: absolute;
  width: 100%;
  height: 100%;
  overflow: visible;
}

.mm-text-line-svg {
  overflow: visible;
}

.mm-text-dot {
  position: absolute;
  width: 8px;
  height: 8px;
  border-radius: 50%;
  background: #7B7EFF;
  top: 50%;
  transform: translateY(-50%);
  box-shadow: 0 0 0 2px rgba(123, 126, 255, 0.2);
  z-index: 2;
}

.mm-text-line-h {
  position: absolute;
  height: 2.5px;
  background: rgba(123, 126, 255, 0.5);
  border-radius: 1px;
  z-index: 1;
}

.mm-text-line-v {
  position: absolute;
  width: 2.5px;
  background: rgba(123, 126, 255, 0.5);
  border-radius: 1px;
  z-index: 1;
}

/* Display — 第一条规则（后面的 block 覆盖 flex，这里只保留公共属性）*/
.mm-node__display {
  width: 100%; user-select: none;
}
.mm-node__label { line-height: 1.35; }
.mm-node__rich  { line-height: 1.35; }
.mm-node__placeholder { color: #b0b4c8; font-style: italic; font-size: 0.72rem; }

/* Colored tokens */
.mm-token-mention { color: var(--mm-accent-dark); font-weight: 500; }
.mm-token-date    { color: #d97706; font-weight: 500; }

/* 节点内容区：flex:1 横向撑满，纵向跟随文字自动伸高 */
.mm-node__body {
  flex: 1; min-width: 0;
  display: flex; align-items: flex-start;
}
/* 展示区：block 布局，宽度充满，允许文字换行 */
.mm-node__display {
  display: block; width: 100%; user-select: none;
}
.mm-node__label, .mm-node__rich {
  display: block;
  white-space: normal; word-break: break-word; overflow-wrap: break-word;
  line-height: 1.45; min-width: 0;
}
/* @人名、#时间 token 整体不断行（可换行到下一行，但内部不拆分） */
.mm-token-mention, .mm-token-date { white-space: nowrap; }

/* Edit textarea — 与 display 完全同款样式，实现所见即所得 */
.mm-node__edit-wrap { position: relative; width: 100%; }
.mm-node__input {
  display: block;
  width: 100%; min-width: 0;
  padding: 0; margin: 0;
  border: none; outline: none; resize: none; overflow: hidden;
  background: transparent;
  font-size: 0.8rem; font-family: inherit;
  color: #2D2F45;
  line-height: 1.45;        /* 与 mm-node__label/rich 保持一致 */
  white-space: normal; word-break: break-word; overflow-wrap: break-word;
  box-sizing: border-box;
}
.mm-node__input::placeholder { color: #b0b4c8; font-size: 0.72rem; }

/* 折叠/展开徽标 — 绝对定位到连线起点（sourcePos 方向的边缘中点），显示子节点数量 */
.mm-node__badge {
  position: absolute;
  width: 18px; height: 18px;
  border-radius: 50%;
  background: #ffffff;
  border: none;
  outline: none;
  color: var(--mm-accent);
  font-size: 0.68rem; font-weight: 600; line-height: 1;
  cursor: pointer;
  display: flex; align-items: center; justify-content: center;
  transition: background 0.15s, color 0.15s;
  z-index: 3;
  box-shadow: 0 1px 3px rgba(0,0,0,0.13);
  padding: 0;
}
/* 根据连线起点方向定位 */
.mm-node__badge[data-pos="right"]  { right: -9px;   top: 50%; transform: translateY(-50%); }
.mm-node__badge[data-pos="left"]   { left: -9px;    top: 50%; transform: translateY(-50%); }
.mm-node__badge[data-pos="bottom"] { bottom: -9px;  left: 50%; transform: translateX(-50%); }
.mm-node__badge[data-pos="top"]    { top: -9px;     left: 50%; transform: translateX(-50%); }

.mm-node__badge:hover {
  background: var(--mm-l2-bg);
  color: var(--mm-accent-dark);
}
/* 折叠状态：实心紫色，白色数字，更醒目 */
.mm-node__badge--collapsed {
  background: var(--mm-accent);
  color: #fff;
}
.mm-node__badge--collapsed:hover {
  background: var(--mm-accent-dark);
  color: #fff;
}

/* Handles — invisible by default, accent on hover */
.mm-handle.react-flow__handle {
  width: 6px; height: 6px;
  background: var(--mm-accent); border: 2px solid #fff; opacity: 0;
  transition: opacity 0.15s;
}
.mm-node:hover .mm-handle.react-flow__handle,
.mm-node--selected .mm-handle.react-flow__handle { opacity: 1; }

/* ── Dropdowns — Portal-based (position:fixed injected inline) ── */
.mm-dropdown {
  background: var(--color-surface);
  border: 1px solid var(--color-border);
  border-radius: 8px;
  box-shadow: 0 6px 20px rgba(0,0,0,0.14);
  min-width: 180px;
  overflow: hidden;
}

/* Member list */
.mm-mention-list { max-height: 180px; overflow-y: auto; }
.mm-dropdown-item {
  display: flex; align-items: center; gap: 0.5rem;
  width: 100%; text-align: left; padding: 0.5rem 0.75rem;
  background: none; border: none;
  font-size: 0.8125rem; color: var(--color-text-main);
  cursor: pointer; transition: background 0.1s;
}
.mm-dropdown-item:hover,
.mm-dropdown-item--active { background: var(--color-input-bg); }
.mm-dropdown-item--active { color: var(--color-primary); }
.mm-avatar {
  width: 22px; height: 22px; border-radius: 50%;
  background: var(--color-primary-light); color: var(--color-primary);
  font-size: 0.625rem; font-weight: 700;
  display: flex; align-items: center; justify-content: center;
  flex-shrink: 0;
}

/* Date picker wrapper */
.mm-date-wrap { padding: 0.75rem; min-width: 220px; }
.mm-date-label {
  display: block; font-size: 0.75rem; font-weight: 600;
  color: var(--color-text-secondary); margin-bottom: 0.375rem;
}
.mm-date-input {
  width: 100%; padding: 0.375rem 0.5rem;
  border: 1px solid var(--color-border); border-radius: 6px;
  font-size: 0.8125rem; color: var(--color-text-main);
  background: var(--color-input-bg); outline: none;
}
.mm-date-input:focus { border-color: var(--color-primary); }

/* ── Overlay modals ────────────────────────── */
.mm-overlay {
  position: fixed; inset: 0;
  background: rgba(0,0,0,0.22);
  display: flex; align-items: center; justify-content: center;
  z-index: 1000;
}
.mm-modal {
  background: var(--color-surface);
  border: 1px solid var(--color-border);
  border-radius: 12px;
  box-shadow: 0 8px 30px rgba(0,0,0,0.14);
  width: 400px; max-width: 92vw; overflow: hidden;
}
.mm-modal-header {
  display: flex; align-items: center; gap: 0.5rem;
  padding: 0.75rem 1rem;
  border-bottom: 1px solid var(--color-border);
  font-weight: 600; font-size: 0.9rem; color: var(--color-text-main);
}
.mm-modal-close {
  margin-left: auto; background: none; border: none;
  cursor: pointer; color: var(--color-text-muted);
  display: flex; padding: 0.125rem; border-radius: 4px; width: auto;
}
.mm-modal-close:hover { color: var(--color-text-main); }
.mm-modal-body { max-height: 260px; overflow-y: auto; padding: 0.375rem 0; }
.mm-search-input {
  flex: 1; border: none; outline: none; background: transparent;
  font-size: 0.9375rem; color: var(--color-text-main); width: auto; padding: 0;
}
.mm-empty { padding: 0.75rem 1rem; font-size: 0.875rem; color: var(--color-text-muted); }
.mm-list-item {
  display: block; width: 100%; text-align: left;
  padding: 0.5rem 1rem; background: none; border: none;
  font-size: 0.875rem; color: var(--color-text-main);
  cursor: pointer; transition: background 0.12s;
}
.mm-list-item:hover { background: var(--color-input-bg); }

/* Shortcuts table */
.mm-shortcuts { width: 440px; }
.mm-sc-table { width: 100%; border-collapse: collapse; font-size: 0.8125rem; }
.mm-sc-table td { padding: 0.4rem 1rem; vertical-align: middle; }
.mm-sc-table tr:not(:last-child) td { border-bottom: 1px solid var(--color-border); }
.mm-sc-cat {
  color: var(--color-text-muted); width: 3rem; font-size: 0.7rem;
  text-transform: uppercase; font-weight: 700;
}
.mm-sc-key { width: 9.5rem; }
.mm-sc-desc { color: var(--color-text-secondary); }

kbd {
  display: inline-block; padding: 0.1rem 0.45rem;
  font-size: 0.72rem; font-family: inherit;
  background: var(--color-input-bg); border: 1px solid var(--color-border);
  border-radius: 4px; color: var(--color-text-main);
  box-shadow: 0 1px 0 var(--color-border); white-space: nowrap;
}
